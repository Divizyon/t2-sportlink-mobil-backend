import { PrismaService } from './prisma.service';
import { User, RegisterUserDTO, UpdateUserDTO } from '../models/user';
import bcrypt from 'bcrypt';
import jwt from 'jsonwebtoken';

export class UsersService extends PrismaService {
  /**
   * Kullanıcı adıyla kullanıcıyı bulur
   */
  async findByUsername(username: string) {
    return this.prismaClient.users.findFirst({
      where: { username }
    });
  }

  /**
   * E-posta ile kullanıcıyı bulur
   */
  async findByEmail(email: string) {
    return this.prismaClient.users.findFirst({
      where: { email }
    });
  }

  /**
   * ID ile kullanıcıyı bulur
   */
  async findById(id: bigint) {
    try {
      return this.prismaClient.users.findUnique({
        where: { id }
      });
    } catch (error) {
      console.error('Kullanıcı bulma hatası (ID):', error);
      throw error;
    }
  }

  /**
   * Kullanıcı oluşturur
   */
  async create(userData: RegisterUserDTO) {
    try {
      // Şifreyi hashle
      const hashedPassword = await this.hashPassword(userData.password);
      
      // Kullanıcı verilerini hazırla ve eksik alanlar için varsayılan değerler ata
      const userDataToCreate = {
        username: userData.username,
        email: userData.email,
        password: hashedPassword,
        first_name: userData.first_name || '',
        last_name: userData.last_name || '',
        phone: userData.phone || '',
        profile_picture: userData.profile_picture || '',
        default_location_latitude: Number(userData.default_location_latitude || 0),
        default_location_longitude: Number(userData.default_location_longitude || 0),
        role: userData.role || 'user',
      };
      
      // Verileri doğrula
      if (!userDataToCreate.username || !userDataToCreate.email || !userDataToCreate.password) {
        throw new Error('Zorunlu alanlar eksik: username, email veya password');
      }
      
      return this.prismaClient.users.create({
        data: userDataToCreate
      });
    } catch (error) {
      console.error('Kullanıcı oluşturma hatası:', error);
      throw error;
    }
  }

  /**
   * Kullanıcı bilgilerini günceller
   */
  async update(id: bigint, userData: UpdateUserDTO) {
    try {
      return this.prismaClient.users.update({
        where: { id },
        data: userData
      });
    } catch (error) {
      console.error('Kullanıcı güncelleme hatası:', error);
      throw error;
    }
  }

  /**
   * Kullanıcı şifresini günceller
   */
  async updatePassword(id: bigint, newPassword: string) {
    try {
      // Şifreyi hashle
      const hashedPassword = await this.hashPassword(newPassword);
      
      return this.prismaClient.users.update({
        where: { id },
        data: { password: hashedPassword }
      });
    } catch (error) {
      console.error('Şifre güncelleme hatası:', error);
      throw error;
    }
  }

  /**
   * Şifre hashleme yardımcı metodu
   */
  private async hashPassword(password: string): Promise<string> {
    const salt = await bcrypt.genSalt(10);
    return await bcrypt.hash(password, salt);
  }

  /**
   * Şifre doğrulama
   */
  async verifyPassword(plainPassword: string, hashedPassword: string): Promise<boolean> {
    return bcrypt.compare(plainPassword, hashedPassword);
  }

  /**
   * JWT token oluşturma
   */
  generateToken(user: User): string {
    const jwtSecret = process.env.JWT_SECRET || 'default_secret';
    const payload = { 
      id: user.id.toString(),
      email: user.email, 
      username: user.username,
      role: user.role 
    };
    
    // @ts-ignore - TypeScript ve jsonwebtoken arasındaki tip uyumsuzluğunu gidermek için
    return jwt.sign(payload, jwtSecret, { 
      expiresIn: process.env.JWT_EXPIRES_IN || '1d' 
    });
  }
}

// Singleton instance
export const usersService = new UsersService(); 